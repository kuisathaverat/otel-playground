---
mode: "daemonset"
image:
  repository: otel/opentelemetry-collector-contrib
  tag: latest
presets:
  logsCollection:
    enabled: true

# clusterRole:
#   create: true
#   rules:
#   - apiGroups:
#     - ""
#     resources:
#     - nodes
#     - services
#     - pods
#     verbs:
#     - get
#     - list
#     - watch
#   - apiGroups:
#     - "networking.k8s.io"
#     resources:
#     - ingresses
#     verbs:
#     - get
#     - watch
#     - list
config:
  exporters:
    debug:
      verbosity: detailed
  extensions:
    health_check:
      endpoint: ${env:MY_POD_IP}:13133
  receivers:
    filelog:
      include:
        - /var/log/pods/*_apache*/*/*.log
      start_at: end
      operators:
        - type: container
          id: container-parser
        - id: apache-logs
          type: regex_parser
          regex: ^(?P<source_ip>\d+\.\d+.\d+\.\d+)\s+-\s+-\s+\[(?P<timestamp_log>\d+/\w+/\d+:\d+:\d+:\d+\s+\+\d+)\]\s"(?P<http_method>\w+)\s+(?P<http_path>.*)\s+(?P<http_version>.*)"\s+(?P<http_code>\d+)\s+(?P<http_size>\d+)$
    prometheus: null
    zipkin: null
  service:
    telemetry: {}
    extensions: [health_check]
    pipelines:
      metrics: null
      traces: null
      logs:
        receivers:
          - filelog
        processors:
          - batch
        exporters:
          - debug
